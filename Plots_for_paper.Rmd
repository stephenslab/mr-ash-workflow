---
title: "Figures_for_the_paper"
output:
  workflowr::wflow_html:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
library(Matrix); library(ggplot2); library(cowplot); library(susieR); library(BGLR);
library(glmnet); library(mr.ash.alpha); library(ncvreg); library(L0Learn); library(varbvs);
standardize = FALSE
source('code/method_wrapper.R')
source('code/sim_wrapper.R')
```

```{r fig1, fig.height=11, fig.width=15, fig.align = "center"}
res_df = readRDS("results/Ridge_for_paper.RDS")
out = matrix(0,9,12)
lower = matrix(0,9,12)
upper = matrix(0,9,12)
for (i in 1:9) {
  out[i,] = colMeans(matrix(res_df[[i]]$pred, 20, 12))
  lower[i,] = apply(matrix(res_df[[i]]$pred, 20, 12), 2, function(x) quantile(x, probs = 0.1))
  upper[i,] = apply(matrix(res_df[[i]]$pred, 20, 12), 2, function(x) quantile(x, probs = 0.9))
}
colnames(out) = c("Mr.ASH","VarBVS","BayesB","Blasso","SuSiE","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn","Mr.ASH.opt")
ind = 1:12
out = out[,ind]
lower = lower[,ind]
upper = upper[,ind]
s_range = c(1,2,5,10,20,50,100,200,500)
col   = gg_color_hue(13)[1:12]
shape = c(19,17,24,25,9,3,11,4,5,7,8,1)
df = data.frame(s = rep(s_range, length(ind)), pred = c(out), fit = rep(colnames(out), each = 9),
                lower = c(lower), upper = c(upper))
df$fit = factor(df$fit, levels =  c("Mr.ASH","E-NET","Lasso","Ridge",
                                    "SCAD","MCP","L0Learn",
                                    "VarBVS","BayesB","Blasso","SuSiE","Mr.ASH.opt"))
df$size = 0.5
df$size[1:9] = 1.2
df = df[df$fit %in% c("Mr.ASH","E-NET","Lasso","Ridge",
                                    "SCAD","MCP","L0Learn"),]
p1 = ggplot(df) + geom_line(aes(x = s, y = pred, color = fit), size = df$size) +
  geom_point(aes(x = s, y = pred, color = fit, shape = fit), size = 3) +
  theme_cowplot(font_size = 14) +
  scale_x_continuous(trans = "log10", breaks = c(1,2,5,10,20,50,100,200,500)) +
  labs(y = "predictior error (rmse / sigma)", x = "number of nonzero coefficients (s)") +
  theme(axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual(values = col) +
  scale_shape_manual(values = shape) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.1,1.2,1.3,1.4)) +
  coord_cartesian(ylim = c(1,1.35), xlim = c(1,600))
fig_main = p1
subtitle  = ggdraw() + draw_label("Scenario: IndepGauss + PointNormal, n = 1000, p = 500, s = 1-500, pve = 0.5", fontface  = 'bold', size = 14) 
fig1      = plot_grid(subtitle,fig_main, ncol = 1, rel_heights = c(0.05,0.95))
```

```{r fig2, fig.height=11, fig.width=15}
res_df       = readRDS("results/signalshape25.RDS")
method_list  = c("Mr.ASH","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn")
method_level = c("Mr.ASH","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn")
col          = gg_color_hue(13)[1:11]
x_range      = 2^(c(1,2,4,5,3,6,7,8) - 1)
df           = data.frame()
for (i in 1:8) {
res_df[[i]]       = res_df[[i]][1:140,]
res_df[[i]]$fit   = rep(method_list, each = 20)
res_df[[i]]$fit   = factor(res_df[[i]]$fit, levels = method_level)
df                = rbind(df, data.frame(pred = c(colMeans(matrix(res_df[[i]]$pred, 20, 7))),
                                         df   = x_range[i],
                                         fit  = method_list))
}
df$size = 0.5
df$size[1:8] = 1.2
df$fit = factor(df$fit, levels = method_level)
col   = gg_color_hue(13)[1:7]
shape = c(19,17,24,25,9,3,11,4,5,7,8,1)[1:7]
p1    = ggplot(df) + geom_line(aes(x = df, y = pred, color = fit), size = df$size) +
  geom_point(aes(x = df, y = pred, color = fit, shape = fit), size = 2.5) +
  theme_cowplot(font_size = 14) +
  scale_x_continuous(trans = "log10", breaks = c(1,2,4,8,16,32,64,128),
                     labels = c("t (df=1)","t (df=2)","Laplace","t (df=4)","t (df=8)",
                                "Normal","Uniform","Constant")) +
  labs(y = "predictior error (rmse / sigma)", x = "distribution of nonzero coefficients") +
  theme(axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5),
        axis.text.x  = element_text(angle = 45,hjust = 1),
        legend.position = "none") +
  scale_color_manual(values = col) +
  scale_shape_manual(values = shape) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.1,1.2,1.3,1.4)) +
  coord_cartesian(ylim = c(1,1.35))
fig_main = p1
subtitle  = ggdraw() + draw_label("Scenario: IndepGauss + Spike-and-Slab, n = 1000, p = 500, s = 200, pve = 0.5", fontface  = 'bold', size = 14) 
fig2      = plot_grid(subtitle,fig_main, ncol = 1, rel_heights = c(0.05,0.95))
```

```{r fig3, fig.height=11, fig.width=15}
res_df       = readRDS("results/diffpve.RDS")
method_list  = c("Mr.ASH","VarBVS","BayesB","Blasso","SuSiE","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn")
method_level = c("Mr.ASH","E-NET","Lasso","Ridge",
                 "SCAD","MCP","L0Learn",
                 "VarBVS","BayesB","Blasso","SuSiE")
col          = gg_color_hue(13)[1:11]
shape        = c(19,17,24,25,9,3,11,4,5,7,8)
pve_list     = seq(0,0.9,0.1)
sdat         = data.frame()
for (i in 1:10) {
  sdat = rbind(sdat, data.frame(pred = colMeans(matrix(res_df[[i]]$pred, 20, 11)),
                                time = colMeans(matrix(res_df[[i]]$time, 20, 11)),
                                fit  = method_list,
                                pve  = pve_list[i]))
}
sdat$fit = factor(sdat$fit, levels = method_level)
sdat     = sdat[sdat$fit %in% c("Mr.ASH","E-NET","Lasso","Ridge",
                 "SCAD","MCP","L0Learn"),]
sdat$size = 0.5
sdat$size[1:10] = 1.2

p1 = ggplot(sdat) + geom_line(aes(x = pve, y = pred, color = fit), size = sdat$size) +
  geom_point(aes(x = pve, y = pred, color = fit, shape = fit), size = 2.5) +
  scale_x_continuous(breaks = pve_list) +
  theme_cowplot(font_size = 14) +
  labs(y = "predictior error (rmse / sigma)", x = "proportion of variance explained (pve)") +
  theme(axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual(values = col) +
  scale_shape_manual(values = shape) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.1,1.2,1.3,1.4)) +
  coord_cartesian(ylim = c(1,1.35))

subtitle  = ggdraw() + draw_label("Scenario: IndepGauss + PointNormal, n = 500, p = 2000, s = 20, pve = 0-0.9", fontface  = 'bold', size = 14) 
fig3      = plot_grid(subtitle,p1, ncol = 1, rel_heights = c(0.05,0.95))
```


```{r fig4, fig.height=13, fig.width=15}
res_df       = readRDS("results/highdimdiffnpnew.RDS")
method_list  = c("Mr.ASH","E-NET","Lasso","Ridge","SCAD","MCP","SCAD2","MCP2","L0Learn")
df           = data.frame()
p_range      = c(20,50,100,200,500,1000,2000,5000,10000,20000)
for (i in 1:10) {
res_df[[i]]$fit   = rep(method_list, each = 20)
res_df[[i]]$fit   = factor(res_df[[i]]$fit, levels = method_list)
df                = rbind(df, data.frame(pred = c(colMeans(matrix(res_df[[i]]$pred, 20, 9))),
                                         time2 = apply(matrix(res_df[[i]]$time, 20, 9), 2, median),
                                         time = c(colMeans(matrix(res_df[[i]]$time, 20, 9))),
                                         p    = p_range[i],
                                         fit  = method_list))
}
df$fit = factor(df$fit, levels = method_list)
df = df[df$fit %in% c("Mr.ASH","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn"),]
df$size = 0.5
df$size[1:7] = 1.2
df = df[df$p %in% c(20,50,200,500,1000,2000,10000,20000),]
col   = gg_color_hue(13)[1:9]
shape = c(19,17,24,25,9,3,11,4,5,7,8,1,2,6)[1:9]
p1    = ggplot(df) + geom_line(aes(x = p, y = pred, color = fit), size = df$size) +
  geom_point(aes(x = p, y = pred, color = fit, shape = fit), size = 2.5) +
  theme_cowplot(font_size = 14) +
  scale_x_continuous(trans = "log10", breaks = c(20,50,200,500,1000,2000,10000,20000)) +
  labs(y = "predictior error (rmse / sigma)", x = "number of coefficients (p)") +
  theme(axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual(values = col) +
  scale_shape_manual(values = shape) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.1,1.2,1.3,1.4)) +
  coord_cartesian(ylim = c(1,1.35))
fig_main = p1
subtitle  = ggdraw() + draw_label("Scenario: IndepGauss + PointNormal, n = 500, p = 20-20000, s = 20, pve = 0.5", fontface  = 'bold', size = 14) 
fig4     = plot_grid(subtitle,fig_main, ncol = 1, rel_heights = c(0.05,0.95))
```

```{r fig5, fig.height=13, fig.width=15}
res_df = readRDS("results/newridge20.RDS")
out = matrix(0,5,15)
for (i in 1:5) {
  out[i,] = colMeans(matrix(res_df[[i]]$pred, 20, 15))
}
s_range       = c(1,10,100,1000,10000)
method_list   = c("varbvs","bayesb","blasso","susie","enet","lasso","ridge","scad2","mcp2","l0learn")
method_list2  = c("mr.ash",method_list,"enet2","lasso2","ridge2","mr.ash.opt")
colnames(out) = method_list2
out           = out[,c(1:11,15)]
colnames(out) = c("Mr.ASH","VarBVS","BayesB","Blasso","SuSiE","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn","Mr.ASH.opt")
ind = c(1,6:11)
out = out[,ind]

col   = gg_color_hue(13)[c(1:7,13)]
shape = c(19,17,24,25,9,3,11,4,5,7,8,2,1)[c(1:7,13)]
df = data.frame(s = rep(s_range, length(ind)), pred = c(out), fit = rep(colnames(out), each = 5))
df$fit = factor(df$fit, levels =  c("Mr.ASH","E-NET","Lasso","Ridge",
                                    "SCAD","MCP","L0Learn","E-NET2","Lasso2","Ridge2",
                                    "VarBVS","BayesB","Blasso","SuSiE","Mr.ASH.opt"))
df$size = 0.5
df$size[1:5] = 1.2
p1 = ggplot(df) + geom_line(aes(x = s, y = pred, color = fit), size = df$size) +
  geom_point(aes(x = s, y = pred, color = fit, shape = fit), size = 2.5) +
  theme_cowplot(font_size = 14) +
  scale_x_continuous(trans = "log10", breaks = s_range) +
  labs(y = "predictior error (rmse / sigma)", x = "number of nonzero coefficients (s)") +
  theme(axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual(values = col) +
  scale_shape_manual(values = shape) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.1,1.2,1.3,1.4)) +
  coord_cartesian(ylim = c(1,1.47))
fig_main  = p1
subtitle  = ggdraw() + draw_label("Scenario: IndepGauss + Normal, n = 500, p = 10000, s = 1-10000, pve = 0.5", fontface  = 'bold', size = 14) 
fig5      = plot_grid(subtitle,fig_main, ncol = 1, rel_heights = c(0.05,0.95))
```

```{r fig6, fig.height=13, fig.width=15}
res_df       = readRDS("results/equicorr30.RDS")
method_list  = c("Mr.ASH","VarBVS","BayesB","Blasso","SuSiE","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn",
                 "Mr.ASH.order","Mr.ASH.init")
method_level = c("Mr.ASH","Mr.ASH.order","Mr.ASH.init","E-NET","Lasso","Ridge",
                 "SCAD","MCP","L0Learn",
                 "VarBVS","BayesB","Blasso","SuSiE")
col          = gg_color_hue(13)[c(1,12,13,2:11)]
rho_list     = c(0,0.6,0.9,0.95,0.99)
a            = c(1,3,4,5,6)
out = matrix(0,5,13)
for (i in 1:5) {
  out[i,] = colMeans(matrix(res_df[[a[i]]]$pred, 20, 13))
}
colnames(out) = c("Mr.ASH","VarBVS","BayesB","Blasso","SuSiE","E-NET","Lasso","Ridge",
                  "SCAD","MCP","L0Learn",
                  "Mr.ASH.order",
                  "Mr.ASH.init")
ind = c(1,6:13)
out = out[,ind]

col   = gg_color_hue(13)[c(1:7,12:13)]
shape = c(19,17,24,25,9,3,11,4,5,7,8,10,1)[c(1:7,12:13)]
df = data.frame(x = rep(1:length(rho_list),length(ind)), rho = rep(rho_list, length(ind)),
                pred = c(out), fit = rep(colnames(out), each = length(rho_list)))
df$fit = factor(df$fit, levels =  c("Mr.ASH","E-NET","Lasso","Ridge",
                                    "SCAD","MCP","L0Learn","E-NET2","Lasso2","Ridge2",
                                    "VarBVS","BayesB","Blasso","SuSiE",
                                    "Mr.ASH.order",
                                    "Mr.ASH.init"))
df$size = 0.5
df$size[1:length(rho_list)] = 1.2
df$lt = "solid"
df$lt[36:40] = "dashed"
fig_dummy = ggplot(df) + geom_line(aes(x = x, y = pred, color = fit), size = df$size, linetype = df$lt) +
  geom_point(aes(x = x, y = pred, color = fit, shape = fit), size = 2.5) +
  theme_cowplot(font_size = 14) +
  scale_x_continuous(breaks = c(1,2,3,4,5),
                     labels = c("0","0.6","0.9","0.95","0.99")) +
  labs(y = "predictior error (rmse / sigma)", x = "correlation across columns of X (rho)") +
  theme(axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = col) +
  scale_shape_manual(values = shape) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.05,1.1,1.15,1.2,1.3,1.4)) +
  coord_cartesian(ylim = c(1,1.12))
p1        = fig_dummy + theme(legend.position = "none")
fig_main  = p1
subtitle  = ggdraw() + draw_label("Scenario: EquiCorrGauss + Normal, n = 500, p = 200, s = 20, pve = 0.5", fontface  = 'bold', size = 14) 
fig6      = plot_grid(subtitle,fig_main, ncol = 1, rel_heights = c(0.05,0.95))
```

```{r figure1, fig.height=20, fig.width=16}
figure1  = plot_grid(fig1,fig5,fig4,fig3,fig2,fig6, ncol = 2, rel_widths = c(0.5,0.5))
title    = ggdraw() + draw_label("Prediction Error (RMSE / sigma)", fontface = 'bold', size = 20)
#subtitle = ggdraw() + draw_label("[Top Left] Sparsity, [Top Right] Signal Shape, [Bottom Left] PVE, [Bottom Right] p", fontface = 'bold', size = 17)
legend <- get_legend(fig_dummy + theme(legend.box.margin = margin(0, 0, 0, 12)))
figure1  = plot_grid(plot_grid(title, figure1, ncol = 1, rel_heights = c(0.05,0.95)), legend, nrow = 1, rel_widths = c(0.9,0.1))
ggsave("figures/figure2_paper.pdf", figure1, width = 18, height = 22)
figure1
```

```{r figure2, fig.height = 16, fig.width = 15, eval = FALSE}
res_df       = readRDS("results/equicorr30.RDS")
method_list  = c("Mr.ASH","VarBVS","BayesB","Blasso","SuSiE","E-NET","Lasso","Ridge","SCAD","MCP","L0Learn",
                 "Mr.ASH.order","Mr.ASH.init")
method_level = c("Mr.ASH","Mr.ASH.order","Mr.ASH.init","E-NET","Lasso","Ridge",
                 "SCAD","MCP","L0Learn",
                 "VarBVS","BayesB","Blasso","SuSiE")
col          = gg_color_hue(13)[c(1,12,13,2:11)]
rho_list     = c(0,0.3,0.6,0.9,0.95,0.99)
for (i in 1:6) {
res_df[[i]]$fit   = rep(method_list, each = 20)
res_df[[i]]$fit   = factor(res_df[[i]]$fit, levels =  method_level)
}
pp = list()
for (i in 1:6) {
  d       = res_df[[i]]
  pp[[i]] = my.box2(d, "fit", "pred", cols = col) +
  theme(axis.line    = element_blank(),
        axis.text.x  = element_text(angle = 45,hjust = 1),
        legend.position = "none") +
  geom_hline(yintercept = mean(d$pred[d$fit == "Mr.ASH.init"]), col = col[3],
             linetype = "dotted", size = 1) +
  scale_y_continuous(trans = "log10", breaks = c(1,1.2,1.4,1.6,1.8,2.0)) +
  coord_cartesian(ylim = c(1,1.25))
  subtitle  = ggdraw() + draw_label(paste(paste("rho = ",rho_list[i], sep = ""),"", sep = ""),
                                    fontface  = 'bold', size = 14)
  pp[[i]]   = plot_grid(subtitle, pp[[i]], ncol = 1, rel_heights = c(0.03,0.95))
}
fig_main  = plot_grid(pp[[3]],pp[[4]],pp[[5]],pp[[6]], nrow = 2, rel_widths = c(0.3,0.3,0.3,0.3))
title     = ggdraw() + draw_label("Prediction Error (log-scale)", fontface = 'bold', size = 20) 
subtitle  = ggdraw() + draw_label("Scenario: LocalCorrGauss + SparseNormal, n = 500, p = 2000, pve = 0.5", fontface = 'bold', size = 17)
figure2  = plot_grid(title,plot_grid(subtitle,fig_main, ncol = 1, rel_heights = c(0.05,0.95)), ncol = 1, rel_heights = c(0.05,0.95))
ggsave("figures/figure3_paper.pdf", figure2, width = 18, height = 12)
figure2
```